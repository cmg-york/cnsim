# CNSim – Event-Based Simulator for Consensus Networks
## Draft Conceptual Document:

### CNSim Overview:
CNSim is a consensus network simulation system designed as an event-based simulator to simulate the performance of
different types of blockchains (e.g. Bitcoin, Tangle).

The simulator represents a framework which individuals can use to simulate any consensus protocol by using the key
components of the Engine, which is the key idea of the CNSim. One of the benefits of developing such a simulator
is its efficiency and flexibility, which allows to study various consensus protocols (e.g. Bitcoin, Tangle, Ethereum,
etc.), allowing individuals to download the Engine and create their own consensus network simulator and implementing
their own protocol. The existing framework allows to simulate large numbers of network events and node behaviors
for different consensus protocols without having to implement everything from scratch.

This document focuses on outlining the architecture and main components of the existing simulator as well as record
suggestions for improvement. The document will be edited/expanded over time once the team becomes more familiar with
CNSim, improves current core functions and implements new features.

### Scope:
The simulator does not focus on hops of the messages from one node to another as it would be time-consuming and
inefficient to simulate all propagation events for every node. Therefore, we assume that every node is connected with
all other nodes conceptually.

### Architecture & Main Components:
The simulator contains multiple packages, each being responsible for a particular function of the program: <br>
#### Bitcoin: contains a number of classes designed to simulate the Bitcoin consensus network:

| **Class**                                         | **Description**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
|---------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **BitcoinMainDriver**                             | Entry point of the CNSim for Bitcoin-based simulations. <br> <br/> The class is responsible for reading settings from a configuration file, which sets the simulation parameters (e.g., number of nodes, random seeds, number of transactions, etc.). <br> The driver allows for creation of a Sampler, which is either “file-based” (loads from files or generates standard data) or “standard sampler” (relies on standard data) depending on configuration. <br> In addition, the driver: <ul><li>Generates random events and intervals to the next event.</li><li>Creates a NodeSet, a set of nodes that participate in the network.</li><li>Creates a Network, which represents a matrix where nodes are connected with a bandwidth (bits per second) with every other node.</li><li>Creates a set of Transactions processed by the Network.</li><li>Flushes the reports to log the simulation results.</li><li>If the simulation is configured to have malicious nodes, the driver allows the user to select specific transactions for attack.</li></ul> |
| **BitcoinNode (subclass of Node class)**          | <li> Extends the blockchain’s Node to contain the behavior and attributes specific to a Bitcoin node, including mining (e.g., existence of a mining pool, mining thresholds), transaction handling, and blockchain maintenance. <li> Decides whether it is worth starting or continuing to mine based on transaction value. <li> Has its Node Behavior Strategy (honest or malicious) which determines the node’s behavior in the network. <li> Provides a way to create and configure nodes, determining their behavior (honest or malicious) and setting properties based on configuration and sampler. <li> Checks configuration settings to check if a malicious node should be created. <li> Only one malicious node can be created; after creation of the first one, the following calls will produce honest nodes only                                                                                                                                                                                                                                  |
| **Bitcoin Reporter (subclass of Reporter class)** | Responsible for adding logs regarding Bitcoin’s blockhain and block information, producing BlockLog (to track the state of the Bitcoin blocks such as block content, difficulty, cycles, etc.) and StructureLog (to track the state of the Bitcoin blockchain structure, including sequences and orphans).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **Block (subclass of TransactionGroup)**          | Represents a block in Bitcoin blockchain & extends Transaction Group, a list to contain transactions. Each block contains a list of grouped transactions and other data, including block's identity, position, validation process and current status. This information allows to view and track block's history, and maintaining integrity and order of the Bitcoin's blockchain.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **Blockchain**                                    | Represents how blocks, orphans and tips (latest blocks) are managed in a Bitcoin blockchain & implements IStructure. Blocks are connected in a blockchain starting from the genesis block to the head of the chain. (add more)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **Block Height Comparator**                       | Compares blocks based on their position in the blockchain (i.e. height) and then further sorts them by IDs (if heights are the same), which allows the ability to perform operations in the right order.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **Honest Node Behaviour**                         | Specifies standard "honest" node behaviour, engaging in receiving, adding valid transactions to the node's pool, propagating to other nodes and block validating activities as per normal rules.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **Malicious Node Behaviour**                      | Specifies "malicious" node behaviour, attempting to shadow "honest" behaviour by receiving and propagating transactions but may also attack. If an attack is in progress, a malicious node will attempt to add new blocks to a hidden chain, while validating and extending the chain, and deciding when to reveal the hidden chain (if the hidden chain is longer than the public chain or because of the public chain reaching maximum lenght). The goal of such behaviour is to cause disruptions to the Bitcoin blockchain's integrity and replace the valid public chain with a hidden "malicious" one.                                                                                                                                                                                                                                                                                                                                                                                                                                                   | |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |

#### Engine:
The Engine includes main components that allow event management, specifies network structure, defines the node and its
functions, as well as specifies the nodeset in a network. Engine represents the main idea behind the CNSim, allowing
developers to download the engine and develop their own simulator and implement their own protocol(this is what is
being done with Bitcoin and Tangle). Engine is designed to work independently of protocols.

The Node implements the logic and the rules of the Network with the Node being specialized
(e.g. Bitcoin, Tangle or other created protocol) and responds to an Event in a defined behaviour.

The Engine package contains 5 subpackages:

| **Subpackage**  | **Description**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
|-----------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Event**       | Superclass Event and 4 of its subclasses – event types: <li> New Transaction Arrival <li> Transaction Propagation <li> Container Validation <li> Container Arrival                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **Message**     | Responsible for protocol coordination, allows for message exchange between different nodes of the network.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                                                                                                                                           || **Network**     | Focuses on network handling                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **Node**        | Contains basic structure of the node in a blockchain consensus network, specifies its basic attributes and functionalities for a node in a network (e.g. event handling and management of transactions); is designed as a base class for specialized nodes (e.g. Bitcoin, Tangle) Nodes, each with a unique ID, participate in simulations that model the blockchain consensus network                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **Transaction** | Represents a transaction in a consensus network. This subpackage contains the following important classes of CNSim: <br> <br/> <li> Reporter Class: superclass which logs and reports different metrics of the simulation, being responsible for producing the following logs: eventLog: a log line is added for each processed event; the log tracks 4 types of events: <ul><li> New Transaction Arrival (new transactions arrive at different nodes), </li><li> Transaction Propagation (propagates a transaction to other nodes), <li> Container Validation, <li> Container Arrival <br/> <br> Reporter produces the following logs: <ul> <li> inpuTxLog: a log line is added for every arrival event transaction; tracks processed transactions <li> nodeLog: a log line is added for every node at the end of the simulation; tracks information about the nodes <li> netLog: tracks network communication between the nodes |

<br/> <li> Simulation Class: Engine also contains the Simulation class, one of the key classes of CNSim. (TO DO: add simulation description)

### Tangle:
The team will add to this part once we familiarize ourselves with this portion of the code. 


 